name: Deploy Aurify SSR to Cloud Run (me-central1)

on:
  push:
    branches: [ master ]
    paths:
      - "aurify-web/**"
      - ".github/workflows/deploy-cloudrun.yml"

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: aurify1225
  GCP_REGION: me-central1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Verify gcloud context
        run: |
          gcloud --version
          gcloud config list

      # âœ… Non-failing pre-check: do NOT error if the service isn't created yet
      - name: Check Cloud Run service (allow not-found)
        continue-on-error: true
        run: |
          gcloud run services describe aurify-ssr \
            --region="${{ env.GCP_REGION }}" \
            --project="${{ env.GCP_PROJECT_ID }}" >/dev/null 2>&1 \
            && echo "Service exists" \
            || echo "Service not found yet (ok before first deploy)"

      - name: Ensure Artifact Registry exists (idempotent)
        run: |
          gcloud artifacts repositories describe cloud-run-source-deploy \
            --location="${{ env.GCP_REGION }}" \
            --project="${{ env.GCP_PROJECT_ID }}" \
          || gcloud artifacts repositories create cloud-run-source-deploy \
               --location="${{ env.GCP_REGION }}" \
               --repository-format=docker \
               --description="Cloud Run source builds for Aurify1225" \
               --project="${{ env.GCP_PROJECT_ID }}"

      - name: Deploy to Cloud Run (me-central1)
        working-directory: ./aurify-web
        run: |
          gcloud run deploy aurify-ssr \
            --region="${{ env.GCP_REGION }}" \
            --allow-unauthenticated \
            --project="${{ env.GCP_PROJECT_ID }}" \
            --source . \
            --set-env-vars=GCP_REGION="${{ env.GCP_REGION }}" \
            --set-env-vars=BQ_LOCATION=ME-CENTRAL1 \
            --set-secrets=API_KEY=MY_API_KEY:latest

      - name: Verify deploy
        run: |
          gcloud run services describe aurify-ssr \
            --region="${{ env.GCP_REGION }}" \
            --project="${{ env.GCP_PROJECT_ID }}" \
            --format="value(status.url)"
