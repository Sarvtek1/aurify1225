name: Deploy Aurify SSR to Cloud Run (me-central1)

on:
  push:
    branches: [ master ]
    paths:
      - "aurify-web/**"
      - ".github/workflows/deploy-cloudrun.yml"

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: aurify1225
  GCP_REGION: me-central1

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Run all steps from the subfolder so --source . points at aurify-web/
    defaults:
      run:
        working-directory: aurify-web

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud (with BigQuery CLI)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: bq

      - name: Verify gcloud context
        shell: bash
        working-directory: .
        run: |
          gcloud --version
          bq --version || true
          gcloud config list

      # ---------- PDPL guard ----------
      - name: "PDPL guard - BigQuery residency & retention"
        shell: bash
        working-directory: .
        env:
          WRITER_SA: service-671472133551@gcp-sa-logging.iam.gserviceaccount.com
          DATASET_ID: aurify_logs
          BQ_LOCATION: ME-CENTRAL1
        run: |
          set -euo pipefail
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          DS_JSON="$(bq --location="${BQ_LOCATION}" --project_id="${GCP_PROJECT_ID}" show --format=json "${DATASET_ID}")" || {
            echo "ERROR: Dataset ${DATASET_ID} not found in ${GCP_PROJECT_ID} (${BQ_LOCATION})"
            exit 1
          }

          LOCATION_LOWER="$(echo "${DS_JSON}" | jq -r '.location' | tr '[:upper:]' '[:lower:]')"
          if [[ "${LOCATION_LOWER}" != "me-central1" ]]; then
            echo "ERROR: Dataset location is '${LOCATION_LOWER}', expected 'me-central1'"
            exit 1
          fi

          EXP_MS="$(echo "${DS_JSON}" | jq -r '.defaultTableExpirationMs // empty')"
          if [[ -z "${EXP_MS}" || "${EXP_MS}" != "31536000000" ]]; then
            echo "ERROR: defaultTableExpirationMs must be 31536000000 (12 months), got '${EXP_MS:-unset}'"
            exit 1
          fi

          if ! gcloud logging sinks describe bq_aurify_logs >/dev/null 2>&1; then
            echo "ERROR: Logging sink 'bq_aurify_logs' not found"
            exit 1
          fi

          ACCESS_JSON="$(bq --location="${BQ_LOCATION}" --project_id="${GCP_PROJECT_ID}" show --format=prettyjson "${DATASET_ID}")"
          if echo "${ACCESS_JSON}" | jq -e --arg sa "${WRITER_SA}" '.access[]?|select(.userByEmail==$sa)' >/dev/null; then
            echo "OK: Sink writer IAM present"
          else
            echo "ERROR: Sink writer ${WRITER_SA} missing on dataset IAM"
            exit 1
          fi

      # ---------- Build preflight in CI (fail fast) ----------
      - name: Setup Node (match Cloud Buildpacks default)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (clean)
        run: npm ci

      - name: Check Next.js build locally (preflight)
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: '1'

      # ---------- Create a minimal .gcloudignore just for aurify-web ----------
      - name: Create .gcloudignore (speed up source deploy)
        run: |
          cat > .gcloudignore <<'EOF'
          # Ignore git metadata
          .git/
          .github/

          # Node junk
          node_modules/
          npm-debug.log
          yarn.lock
          pnpm-lock.yaml

          # Next build output (Cloud Build will run its own build)
          .next/
          .vercel/

          # Local envs
          .env*
          EOF

      # ---------- Ensure Artifact Registry exists (idempotent) ----------
      - name: Ensure Artifact Registry exists (idempotent)
        shell: bash
        working-directory: .
        run: |
          gcloud artifacts repositories describe cloud-run-source-deploy \
            --location="${GCP_REGION}" \
            --project="${GCP_PROJECT_ID}" \
          || gcloud artifacts repositories create cloud-run-source-deploy \
               --location="${GCP_REGION}" \
               --repository-format=docker \
               --description="Cloud Run source builds for Aurify1225" \
               --project="${GCP_PROJECT_ID}"

      - name: Deploy to Cloud Run (me-central1)
        shell: bash
        run: |
          # Create service account if it doesn't exist
          gcloud iam service-accounts describe aurify-run-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com \
            --project="${GCP_PROJECT_ID}" >/dev/null 2>&1 || \
          gcloud iam service-accounts create aurify-run-sa \
            --display-name="Aurify Cloud Run Runtime SA" \
            --project="${GCP_PROJECT_ID}"
          
          # Grant minimal required roles
          gcloud projects add-iam-policy-binding "${GCP_PROJECT_ID}" \
            --member="serviceAccount:aurify-run-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com" \
            --role="roles/logging.logWriter" \
            --condition=None || true
          
          gcloud projects add-iam-policy-binding "${GCP_PROJECT_ID}" \
            --member="serviceAccount:aurify-run-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com" \
            --role="roles/secretmanager.secretAccessor" \
            --condition=None || true
          
          # Deploy to Cloud Run
          gcloud run deploy aurify-ssr \
            --region="${GCP_REGION}" \
            --allow-unauthenticated \
            --project="${GCP_PROJECT_ID}" \
            --source . \
            --clear-base-image \
            --service-account="aurify-run-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com" \
            --set-env-vars=GCP_REGION="${GCP_REGION}" \
            --set-env-vars=BQ_LOCATION=ME-CENTRAL1 \
            --set-secrets=API_KEY=MY_API_KEY_MEC1:latest \
            --memory=1Gi \
            --concurrency=80 \
            --max-instances=10

      - name: Verify deploy (print service URL)
        shell: bash
        working-directory: .
        run: |
          URL="$(gcloud run services describe aurify-ssr \
            --region="${GCP_REGION}" \
            --project="${GCP_PROJECT_ID}" \
            --format="value(status.url)")"
          echo "Cloud Run URL: ${URL}"
