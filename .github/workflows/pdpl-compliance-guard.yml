name: PDPL Compliance Guard

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Verify Hosting rewrite points to me-central1
        run: |
          test -f firebase.json
          grep -q '"run"' firebase.json
          grep -q '"region": *"me-central1"' firebase.json
          echo "✔ firebase.json references me-central1 for dynamic routes"

      - name: Fail if frameworks backend key is present (we proxy to Cloud Run instead)
        run: |
          if grep -qi 'frameworksBackend' firebase.json; then
            echo "❌ frameworksBackend found; remove and use rewrites → Cloud Run me-central1"
            exit 1
          fi
          echo "✔ frameworksBackend not used"

      - name: Verify compliance docs reference Doha
        run: |
          test -f docs/compliance/pdpl-readiness.md
          grep -qi 'me-central1' docs/compliance/pdpl-readiness.md
          grep -qi 'ME-CENTRAL1' docs/compliance/pdpl-readiness.md
          echo "✔ compliance doc references me-central1 / ME-CENTRAL1"

  infra:
    # Optional: comment the next line to disable this job temporarily
    # if: ${{ false }}
    needs: guard
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_AURIFY1225 }}

      - name: Set project
        run: gcloud config set project aurify1225

      # ✅ Non-fatal precheck: NEVER fail if service is missing
      - name: Check Cloud Run service (allow not-found)
        shell: bash
        continue-on-error: true
        run: |
          set +e
          gcloud run services describe aurify-ssr --region=me-central1 >/dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✔ Cloud Run aurify-ssr present in me-central1"
          else
            echo "ℹ️ Cloud Run service aurify-ssr not found yet in me-central1 (ok before first deploy)"
          fi
          exit 0
